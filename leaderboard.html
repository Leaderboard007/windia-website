<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roobet Wager Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>🔥 Roobet Wager Leaderboard</h1>
    <p id="date-range">⏳ Ends in: calculating...</p>
    <a href="https://roobet.com/?ref=windia" class="play-button" target="_blank">🚀 Play & Win Now!</a>
  </header>
  <main>
    <div class="top3-container" id="top3"></div>
    <table class="leaderboard">
      <thead>
        <tr>
          <th>Rank</th>
          <th>User</th>
          <th>Wagered</th>
          <th>Prize</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
    <div class="share-buttons">
      <a href="#" onclick="alert('Coming soon!')">📣 Share on Telegram</a>
      <a href="#" onclick="alert('Coming soon!')">🎉 Share on Discord</a>
    </div>
  </main>
  <script>
    function maskUsername(username) {
      const first = username.slice(0, 2);
      const last = username.slice(-2);
      return first + "****" + last;
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    }

    function getCycleDates() {
      const today = new Date();
      let start, end;
      if (today.getDate() >= 23) {
        start = new Date(today.getFullYear(), today.getMonth(), 23);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 22);
      } else {
        start = new Date(today.getFullYear(), today.getMonth() - 1, 23);
        end = new Date(today.getFullYear(), today.getMonth(), 22);
      }
      return { start, end };
    }

    async function fetchLeaderboard() {
      try {
        const { start, end } = getCycleDates();
        const response = await fetch('/api/leaderboard');
        const data = await response.json();

        data.sort((a, b) => b.weightedWagered - a.weightedWagered);

        const prizes = ["₹1,000,000", "₹300,000", "₹100,000", "₹50,000", "₹10,000", "₹5,000", "₹5,000", "₹5,000", "₹5,000", "₹5,000", "₹3,000", "₹3,000", "₹3,000", "₹3,000", "₹3,000"];

        const top3Container = document.getElementById('top3');
        const tbody = document.getElementById('leaderboard-body');
        top3Container.innerHTML = '';
        tbody.innerHTML = '';

        const top3 = [data[1], data[0], data[2]];
        top3.forEach((user, i) => {
          if (!user) return;
          const card = document.createElement('div');
          card.className = 'top-card' + (i === 1 ? ' rank-1' : '');
          const badge = document.createElement('div');
          badge.className = 'rank-badge';
          badge.textContent = ['🥈 2nd', '🥇 1st', '🥉 3rd'][i];
          const avatar = document.createElement('img');
          avatar.src = `https://robohash.org/${user.username}.png?size=60x60`;
          avatar.alt = user.username;
          avatar.className = 'avatar';
          const name = document.createElement('div');
          name.className = 'username';
          name.textContent = maskUsername(user.username);
          const wager = document.createElement('div');
          wager.textContent = `Wagered: ${user.weightedWagered.toLocaleString()}`;
          const prize = document.createElement('div');
          prize.className = 'glow-prize';
          prize.textContent = prizes[[1, 0, 2][i]];
          card.appendChild(badge);
          card.appendChild(avatar);
          card.appendChild(name);
          card.appendChild(wager);
          card.appendChild(prize);
          top3Container.appendChild(card);
        });

        data.forEach((user, index) => {
          if (index >= 3 && index < 15) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td class="username-cell">
                <img class="avatar-small" src="https://robohash.org/${user.username}.png?size=30x30" />
                ${maskUsername(user.username)}
              </td>
              <td>${user.weightedWagered.toLocaleString()}</td>
              <td><span class="glow-prize">${prizes[index]}</span></td>
            `;
            tbody.appendChild(tr);
          }
        });
      } catch (error) {
        console.error('Error fetching leaderboard:', error);
      }
    }

    function updateCountdownDisplay() {
      const today = new Date();
      let end;
      if (today.getDate() >= 23) {
        end = new Date(today.getFullYear(), today.getMonth() + 1, 22, 23, 59, 59);
      } else {
        end = new Date(today.getFullYear(), today.getMonth(), 22, 23, 59, 59);
      }

      function pad(n) { return n < 10 ? '0' + n : n; }

      function tick() {
        const now = new Date();
        const diff = end - now;
        const el = document.getElementById('date-range');
        if (!el) return;

        if (diff <= 0) {
          el.textContent = '✅ Cycle ended. Refreshing soon...';
          return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
        const minutes = Math.floor(diff / (1000 * 60)) % 60;
        const seconds = Math.floor(diff / 1000) % 60;
        el.textContent = `⏳ Ends in: ${days}d ${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
      }

      tick();
      setInterval(tick, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateCountdownDisplay();
      fetchLeaderboard();
    });
  </script>
</body>
</html>
